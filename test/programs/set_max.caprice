(* TEST
  include splayable;
*)


let s : type = int

let t : type -> type =
  fun a ->
    s -> { state : s ; body : a }

let bind (type a b) (x : t a) (f : a -> t b) : t b =
  fun s ->
    let v = x s in
    f v.body v.state

let return (type a) (a : a) : t a =
  fun state -> { state ; body = a }

let set state = fun _ -> { state ; body = () }

let read = fun state -> { state ; body = state }

let set_max (dependent x : int) : t { i : int | i >= x } =
  bind int int read (fun max ->
    if max >= x    
    then return int max
    else bind unit int (set x) (fun _ ->
      return int x
    )
  )
